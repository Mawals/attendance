<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نموذج تسجيل مخالفة</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; direction: rtl; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { font-size: 22px; margin-bottom: 20px; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; }
    button { margin-top: 20px; background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
    .pill { margin-top: 10px; background: #eef2ff; padding: 8px 12px; display: inline-block; border-radius: 20px; font-size: 14px; }
  </style>
  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpYkLDu5kwHXqoqZ9WPonUBDVrrbF3eo4hSAiuQosDnrYcrepDiSvTs6o2gBFrAQ/pub?gid=626465739&single=true&output=csv";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxbM7zmeN1gW_ryUSVdTkI8XKkMFyICb2RYbjwBIzc5Hean6J35BI9efjODhvdlnw/exec";

    let studentData = [];

    async function fetchStudentData() {
      const res = await fetch(CSV_URL);
      const text = await res.text();
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");
      studentData = lines.slice(1).map(row => {
        const values = row.split(",");
        const entry = {};
        headers.forEach((h, i) => entry[h.trim()] = values[i] ? values[i].trim() : "");
        return entry;
      });
    }
      const url = `https://docs.google.com/spreadsheets/d/${STUDENTS_SHEET_ID}/gviz/tq?tqx=out:json`;
      const res = await fetch(url);
      const txt = await res.text();
      const json = JSON.parse(txt.substr(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
      const cols = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r => r.c.map(cell => cell ? cell.v : ""));
      studentData = rows.map(r => Object.fromEntries(r.map((v,i)=>[cols[i], v])));
    }

    
    function updateSections() {
      const grade = document.getElementById("grade").value;
      const sections = Array.from(new Set(studentData
        .filter(s => s["الصف"] === grade)
        .map(s => s["الشعبة"])
        .filter(Boolean)));
      const sectionSelect = document.getElementById("section");
      sectionSelect.innerHTML = '<option value="">اختر الشعبة</option>' + sections.map(s => `<option>${s}</option>`).join("");
      sectionSelect.disabled = sections.length === 0;
      document.getElementById("student").innerHTML = '<option value="">اختر اسم الطالب</option>';
      document.getElementById("student").disabled = true;
      document.getElementById("guardian").textContent = "—";
    }

    function updateStudents() {
      const grade = document.getElementById("grade").value;
      const section = document.getElementById("section").value;
      const students = studentData.filter(s => s["الصف"] === grade && s["الشعبة"] === section);
      const studentSelect = document.getElementById("student");
      studentSelect.innerHTML = '<option value="">اختر اسم الطالب</option>' +
        students.map(s => `<option value="${s["الاسم"]}" data-phone="${s["رقم الهاتف"]}">${s["الاسم"]}</option>`).join("");
      studentSelect.disabled = students.length === 0;
      document.getElementById("guardian").textContent = "—";
    }
    " data-phone="${s["رقم الهاتف"]}">${s["الاسم"]}</option>`).join("");
      document.getElementById("guardian").textContent = "—";
    }

    function onStudentChange() {
      const selected = document.querySelector("#student option:checked");
      const phone = selected ? selected.dataset.phone || "—" : "—";
      document.getElementById("guardian").textContent = phone;
      document.getElementById("guardian_phone").value = phone;
    }

    async function sendData() {
      const data = {
        "اسم المعلم أو الإداري": document.getElementById("teacher").value,
        "التخصص": document.getElementById("major").value,
        "الصف": document.getElementById("grade").value,
        "الشعبة": document.getElementById("section").value,
        "اسم الطالب": document.getElementById("student").value,
        "رقم ولي الأمر": document.getElementById("guardian_phone").value,
        "المخالفة": document.getElementById("violation").value
      };
      const missing = Object.entries(data).filter(([k,v]) => !v);
      if (missing.length > 0) return alert("يرجى تعبئة جميع الحقول");

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      alert("✅ تم إرسال المخالفة بنجاح");
      document.getElementById("form").reset();
      document.getElementById("guardian").textContent = "—";
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await fetchStudentData();
      document.getElementById("grade").addEventListener("change", updateSections);
      document.getElementById("section").addEventListener("change", updateStudents);
      document.getElementById("student").addEventListener("change", onStudentChange);
      document.getElementById("send").addEventListener("click", sendData);
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>تسجيل مخالفة سلوكية</h1>
    <form id="form" onsubmit="return false">
      <label>اسم المعلم أو الإداري</label>
      <input id="teacher" placeholder="اسم المعلم" required />

      <label>التخصص</label>
      <input id="major" placeholder="مثال: رياضيات / علوم" required />

      <label>الصف الدراسي</label>
      <select id="grade" required>
<option>5</option>
<option>6</option>
<option>7</option>
<option>8</option>
<option>9</option>
<option>10</option>
<option>11</option>
<option>12</option>
</select>

      <label>الشعبة</label>
      <select id="section" required disabled>
        <option>اختر الشعبة</option>
      </select>

      <label>اسم الطالب</label>
      <select id="student" required disabled>
        <option>اختر اسم الطالب</option>
      </select>

      <label>رقم ولي الأمر</label>
      <div class="pill" id="guardian">—</div>
      <input type="hidden" id="guardian_phone" />

      <label>المخالفة</label>
      <select id="violation" required>
        <option value="">اختر المخالفة</option>
        <option>تأخير</option>
        <option>غياب</option>
        <option>سلوك غير لائق</option>
        <option>عدم إحضار الأدوات</option>
      </select>

      <button id="send">إرسال للمشرف</button>
    </form>
  </div>
</body>
</html>