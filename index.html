<script>
document.addEventListener('DOMContentLoaded', () => {
  // أدوات
  const $  = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const gradeEl   = $('#gradeSelect');
  const sectionEl = $('#sectionSelect');
  const bodyEl    = $('#studentsBody');

  if (!gradeEl || !sectionEl || !bodyEl) {
    console.error('لم أجد عناصر القوائم/الجدول. تأكد من وجود gradeSelect/sectionSelect/studentsBody في DOM.');
    return;
  }

  // الحالة العامة
  window.state = {
    classes: [],
    grade:  null,
    section:null,
    attendance: {},
    teacher: { id:'', name:'' }
  };

  // تبسيط تنسيقات
  function normalizeClassesJson(obj, g, s){
    if (Array.isArray(obj)) {
      if (obj.length && obj[0] && obj[0].students) return obj;
      return [{
        grade: g, section: s,
        students: obj.map(x => ({
          id:    x.id || x.student_id || crypto.randomUUID(),
          name:  x.name || x.student_name || '',
          phone: (x.phone || '').toString().replace(/\s+/g,'')
        }))
      }];
    }
    return [{ grade:g, section:s, students: [] }];
  }

  function updateCounters(){
    const grp  = (state.classes[0]) || {students:[]};
    const list = grp.students || [];
    let present=0, absent=0;
    list.forEach(s => (state.attendance[s.id]===false ? absent++ : present++));
    const abs = $('#absCount'), pres = $('#presCount');
    if (abs)  abs.textContent  = absent;
    if (pres) pres.textContent = present;
  }

  function renderStudents(){
    bodyEl.innerHTML = '';
    const grp  = (state.classes[0]) || {students:[]};
    const list = grp.students || [];

    list.forEach((s,i)=>{
      if(!(s.id in state.attendance)) state.attendance[s.id] = true; // حاضر افتراضيًا
      const on = !!state.attendance[s.id];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${s.name}</td>
        <td>${s.phone || '<span style="color:#94a3b8">—</span>'}</td>
        <td>
          <div class="toggle" data-on="${on}" data-id="${s.id}">
            <div class="knob"></div>
          </div>
        </td>`;
      bodyEl.appendChild(tr);
    });

    $$('#studentsBody .toggle').forEach(el => el.onclick = () => {
      const id = el.getAttribute('data-id');
      const on = el.getAttribute('data-on') === 'true';
      state.attendance[id] = !on;
      el.setAttribute('data-on', String(!on));
      updateCounters();
    });

    updateCounters();
  }

  async function loadSelectedClass(){
    const g = gradeEl.value;
    const s = sectionEl.value;
    if (!g || !s) return;

    const candidates = [
      `classes/classes_from_${g}-${s}_QA.json`,
      `classes/classes_from_${g}-${s}.json`,
      `classes/${g}-${s}.json`
    ];

    for (const url of candidates) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) continue;
        const data = await res.json();
        state.grade=g; state.section=s;
        state.classes = normalizeClassesJson(data, g, s);
        state.attendance = {};
        renderStudents();
        console.log('Loaded:', url);
        return;
      } catch (e) {
        // جرّب التالي
      }
    }

    // لو لم نجد ملفًا مناسبًا
    bodyEl.innerHTML = `
      <tr><td colspan="4" style="color:#fca5a5">
        لم أجد ملف هذا الصف/الشعبة داخل <code>classes</code>.<br>
        جُرّبت الأسماء: <code>${candidates.join('</code>, <code>')}</code>
      </td></tr>`;
    updateCounters();
  }

  // اربط الأحداث الآن (بعد توفر العناصر)
  gradeEl.addEventListener('change', loadSelectedClass);
  sectionEl.addEventListener('change', loadSelectedClass);

  // تحميل تلقائي 5-1 عند الفتح
  gradeEl.value   = '5';
  sectionEl.value = '1';
  loadSelectedClass();
});
</script>
