<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª â€” Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ØµÙ â‡¢ Ø´Ø¹Ø¨Ø© â‡¢ Ø§Ø³Ù…)</title>
  <style>
    :root{--c:#2563eb}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f5f7fb;margin:0;padding:24px}
    .wrap{max-width:900px;margin:0 auto}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 22px rgba(0,0,0,.08);padding:18px 18px 22px;margin-bottom:16px}
    h1{font-size:20px;margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-1{grid-template-columns:1fr}
    label{font-size:13px;margin-bottom:6px;display:block}
    select,input,textarea{width:100%;padding:10px 12px;border:1px solid #e3e6ef;border-radius:10px;background:#fafbff}
    select:disabled{background:#f2f4f8;color:#999}
    textarea{min-height:90px;resize:vertical}
    .muted{font-size:12px;color:#6b7280}
    .row{display:flex;gap:10px;align-items:center}
    .btn{border:0;background:var(--c);color:#fff;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #toast{display:none;background:#111;color:#fff;padding:10px 14px;border-radius:10px;position:fixed;bottom:18px;inset-inline:18px auto;z-index:999}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#283b7b;font-size:12px}
    .note{font-size:12px;color:#374151;background:#f9fafb;border:1px dashed #e5e7eb;border-radius:10px;padding:10px}
  </style>
  <script>
    const GAS_URL   = 'https://script.google.com/macros/s/AKfycbxbM7zmeN1gW_ryUSVdTkI8XKkMFyICb2RYbjwBIzc5Hean6J35BI9efjODhvdlnw/exec';
    const SHEET_ID  = '1c_nu-7OnT5eK03wonJXoIeg2k8--ivJS';

    const $  = (s,c=document)=>c.querySelector(s);
    const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));
    function toast(m){ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
    function clearAll(){
      const f=$('#dataForm'); if(f) f.reset();
      ($('[name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"]'))?.dispatchEvent(new Event('change',{bubbles:true}));
      ($('[name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"]'))?.dispatchEvent(new Event('change',{bubbles:true}));
      ($('[name="Ø§Ù„Ø´Ø¹Ø¨Ø©"]'))?.dispatchEvent(new Event('change',{bubbles:true}));
      $('#guardianPhone').textContent = 'â€”';
    }

    async function fetchStudentsGViz(gid){
      const url = gid ?
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}` :
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
      const resp = await fetch(url);
      const text = await resp.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
      const labels = json.table.cols.map(c => (c && c.label) ? String(c.label).trim() : '');
      const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c ? c.v : ''));
      return rows.map(arr => { const o={}; labels.forEach((lab,i)=>{ o[lab] = (arr[i]==null?'':arr[i]); }); return o; });
    }

    const DB = { raw:[], byGrade:{}, byGradeSection:{}, teachers:[] };

    function buildIndexes(){
      DB.byGrade = {};
      DB.byGradeSection = {};
      const teachersSet = new Set();
      DB.raw.forEach(rec => {
        const teacher = String(rec['Ø§Ù„Ù…Ø¹Ù„Ù…']||'').trim();
        const grade   = String(rec['Ø§Ù„ØµÙ']||'').trim();
        const section = String(rec['Ø§Ù„Ø´Ø¹Ø¨Ø©']||'').trim();
        const name    = String(rec['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨']||'').trim();
        const phone   = String(rec['Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±']||'').trim();
        if(teacher) teachersSet.add(teacher);
        if(!grade) return;
        if(!DB.byGrade[grade]) DB.byGrade[grade] = new Set();
        if(section) DB.byGrade[grade].add(section);
        const key = grade + '::' + section;
        if(!DB.byGradeSection[key]) DB.byGradeSection[key] = [];
        if(name) DB.byGradeSection[key].push({name, phone, teacher});
      });
      DB.teachers = Array.from(teachersSet).sort((a,b)=>a.localeCompare(b,'ar'));
      Object.keys(DB.byGrade).forEach(g => DB.byGrade[g] = Array.from(DB.byGrade[g]).sort((a,b)=>a.localeCompare(b,'ar')));
    }

    function fillGradeOptions(){
      const sel = $('[name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"]');
      const grades = Object.keys(DB.byGrade).sort((a,b)=>a.localeCompare(b,'ar'));
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>' + grades.map(g => `<option>${g}</option>`).join('');
      sel.disabled = false;
      fillSectionOptions('');
      fillStudentOptions('','');
    }

    function fillSectionOptions(grade){
      const sel = $('[name="Ø§Ù„Ø´Ø¹Ø¨Ø©"]');
      if(!grade){ sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ø§Ù‹â€¦</option>'; sel.disabled=true; return; }
      const sections = DB.byGrade[grade] || [];
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>' + sections.map(s => `<option>${s}</option>`).join('');
      sel.disabled = sections.length===0;
      fillStudentOptions(grade, '');
    }

    function fillStudentOptions(grade, section){
      const sel = $('[name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"]');
      const key = grade + '::' + section;
      const list = DB.byGradeSection[key] || [];
      if(!grade || !section || list.length===0){
        sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø«Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©â€¦</option>';
        sel.disabled = true;
        $('#guardianPhone').textContent = 'â€”';
        return;
      }
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>' + list.map(s => `<option value="${s.name}" data-phone="${s.phone}">${s.name}</option>`).join('');
      sel.disabled = false;
      $('#guardianPhone').textContent = 'â€”';
    }

    function onStudentChange(){
      const opt = $('[name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"] option:checked');
      const phone = opt ? (opt.getAttribute('data-phone')||'') : '';
      $('#guardianPhone').textContent = phone || 'â€”';
      $('[name="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±"]').value = phone || '';
    }

    async function sendToSupervisor(){
      const btn = $('#sendBtn'); btn.disabled = true;
      try{
        const data = Object.fromEntries(new FormData($('#dataForm')).entries());
        const req = ['Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ','Ø§Ù„Ø´Ø¹Ø¨Ø©','Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ','Ø§Ù„ØªØ®ØµØµ'];
        const miss = req.filter(k => !data[k] || String(data[k]).trim()==='');
        if(miss.length){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø©: '+miss.join('ØŒ ')); btn.disabled=false; return; }
        const payload = {
          'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': data['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨']||'',
          'Ø§Ù„ØµÙ': data['Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ']||'',
          'Ø§Ù„Ø´Ø¹Ø¨Ø©': data['Ø§Ù„Ø´Ø¹Ø¨Ø©']||'',
          'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©': data['Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©']||'',
          'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ': data['Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ']||'',
          'Ø§Ù„ØªØ®ØµØµ': data['Ø§Ù„ØªØ®ØµØµ']||'',
          'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰': data['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰']||'',
          'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': data['Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±']||''
        };
        const res = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
        let ok=false; let j=null;
        if(res.type==='opaque'){ ok=true; } else { try{ j=await res.json(); }catch(_){} ok = !!(res.ok && j && (j.status==='ok' || j.status==='success')); }
        if(ok){ toast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù âœ…'); clearAll(); } else { alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Web App'); }
      }catch(e){ alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: '+e); }
      finally{ btn.disabled=false; }
    }

    document.addEventListener('DOMContentLoaded', async()=>{
      try{
        DB.raw = await fetchStudentsGViz();
        buildIndexes();
        const teacherSel = $('[name="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ"]');
        teacherSel.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>' + DB.teachers.map(t=>`<option>${t}</option>`).join('');
        fillGradeOptions();
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„Ø´ÙŠØª. ØªØ£ÙƒØ¯ Ø£Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Anyone with the link: Viewer');
      }
      $('[name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"]').addEventListener('change', e=>{ fillSectionOptions(e.target.value); });
      $('[name="Ø§Ù„Ø´Ø¹Ø¨Ø©"]').addEventListener('change', e=>{ fillStudentOptions($('[name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"]').value, e.target.value); });
      $('[name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"]').addEventListener('change', onStudentChange);
      $('#dataForm').addEventListener('submit', e=>{ e.preventDefault(); sendToSupervisor(); });
      $('#sendBtn').addEventListener('click', e=>{ e.preventDefault(); sendToSupervisor(); });
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª â€” Ø§Ø®ØªÙŠØ§Ø± (ØµÙ â‡¢ Ø´Ø¹Ø¨Ø© â‡¢ Ø§Ø³Ù…)</h1>
      <p class="note">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ <strong>Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ£Ø±Ù‚Ø§Ù… Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</strong> Ø¢Ù„ÙŠÙ‹Ø§ Ù…Ù† Google Sheet Ø§Ù„Ù…Ø±Ø¨ÙˆØ·. Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø«Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø«Ù… Ø§Ù„Ø§Ø³Ù…ØŒ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¢Ù„ÙŠÙ‹Ø§ ÙˆÙŠÙØ±Ø³Ù„ Ø¶Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
      <form id="dataForm">
        <div class="grid">
          <div>
            <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
            <select name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ" required disabled>
              <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <select name="Ø§Ù„Ø´Ø¹Ø¨Ø©" required disabled>
              <option>Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ù‹Ø§â€¦</option>
            </select>
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <select name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required disabled>
              <option>Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø«Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©â€¦</option>
            </select>
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</label>
            <select name="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ" required>
              <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©</label>
            <select name="Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©">
              <option value="">Ø§Ø®ØªØ±...</option>
              <option>ØªØ£Ø®ÙŠØ±</option>
              <option>ØºÙŠØ§Ø¨</option>
              <option>Ø³Ù„ÙˆÙƒ</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ØªØ®ØµØµ</label>
            <input name="Ø§Ù„ØªØ®ØµØµ" placeholder="Ù…Ø«Ø§Ù„: Math / Science" required />
          </div>
        </div>

        <div class="grid grid-1" style="margin-top:12px">
          <div>
            <label>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (ÙŠÙØ¹Ø¨Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</label>
            <div class="pill"><span>ğŸ“</span><span id="guardianPhone">â€”</span></div>
            <input type="hidden" name="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" value="">
          </div>
          <div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰</label>
            <textarea name="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <button id="sendBtn" type="submit" class="btn">Ø­ÙØ¸/Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù</button>
        </div>
      </form>
    </div>
  </div>
  <div id="toast"></div>
</body>
</html>
